import type { ChannelSettings, ExtensionSettings, Theme } from '../types';
import type { YoutubeTwitchChatStorageWorker } from './storage';
import type { YoutubeTwitchChatThemeWorker } from './theme';
import { YoutubeTwitchChatPromptWorker } from './prompt';

export class YoutubeTwitchChatChatWorker {
  private channelName: string;
  private channelSettings?: ChannelSettings;
  private storageWorker: YoutubeTwitchChatStorageWorker;
  private themeWorker: YoutubeTwitchChatThemeWorker;
  private promptWorker: YoutubeTwitchChatPromptWorker;
  private youtubeiFrame?: HTMLIFrameElement;
  private twitchIframe?: HTMLIFrameElement;
  private twitchCloseButton?: HTMLButtonElement;
  // Listener references for cleanup
  private storageChangeListener?: (
    changes: {
      [key: string]: chrome.storage.StorageChange;
    },
    areaName: string
  ) => void;
  private chatToggleHandler?: (event: Event) => void;
  private themeChangeHandler?: (theme: Theme) => void;
  // DOM tracking for cleanup
  private chatContainer?: HTMLElement | null;
  private chatContainerOriginalPosition?: string;

  constructor(
    storageWorker: YoutubeTwitchChatStorageWorker,
    themeWorker: YoutubeTwitchChatThemeWorker,
    channelName: string
  ) {
    this.storageWorker = storageWorker;
    this.themeWorker = themeWorker;
    this.channelName = channelName;
    this.promptWorker = new YoutubeTwitchChatPromptWorker(storageWorker, channelName);
    this.init();
  }

  private async init() {
    this.setupEventListeners();
    this.findYouTubeChat();
    this.channelSettings = await this.storageWorker.getChannelSettings(this.channelName);
    if (!this.channelSettings) {
      const twitchChannel = await this.promptWorker.showPrompt();
      if (twitchChannel) {
        this.channelSettings = {
          twitchChannel,
          preferredChat: 'twitch'
        };
      }
    }
    this.updateChatVisibility();
  }

  private updateChatVisibility() {
    if (!this.channelSettings || !this.youtubeiFrame) return;
    const preferredChat = this.channelSettings.preferredChat || 'youtube';
    const showTwitch = preferredChat === 'twitch';

    if (this.channelSettings.twitchChannel && !this.twitchIframe) {
      this.createTwitchChat();
    }

    if (showTwitch) {
      this.hideiFrame(this.youtubeiFrame);

      if (this.twitchIframe) {
        this.showiFrame(this.twitchIframe);
      }
    } else {
      this.showiFrame(this.youtubeiFrame);

      if (this.twitchIframe) {
        this.hideiFrame(this.twitchIframe);
      }
    }
  }

  private createTwitchChat() {
    if (!this.youtubeiFrame || !this.channelSettings?.twitchChannel || this.twitchIframe) return;

    this.getChatContainer();
    if (!this.chatContainer) return;

    // Track original inline style to restore later
    this.chatContainerOriginalPosition = this.chatContainer.style.position;
    if (getComputedStyle(this.chatContainer).position === 'static') {
      this.chatContainer.style.position = 'relative';
    }

    this.twitchIframe = document.createElement('iframe');
    this.twitchIframe.id = `twitch-chat-iframe-${this.channelName}`;
    this.twitchIframe.src = this.getTwitchChatUrl(
      this.channelSettings.twitchChannel,
      this.themeWorker.theme
    );
    this.twitchIframe.setAttribute('allow', 'clipboard-read; clipboard-write');
    this.twitchIframe.className = 'ytd-live-chat-frame';

    this.twitchIframe.style.transition = 'opacity 0.3s ease-in-out';
    this.hideiFrame(this.twitchIframe);

    this.chatContainer.appendChild(this.twitchIframe);

    // Create close button overlay
    this.createTwitchCloseButton();

    this.themeChangeHandler = (theme: 'light' | 'dark') => {
      if (this.twitchIframe && this.channelSettings?.twitchChannel) {
        this.twitchIframe.src = this.getTwitchChatUrl(this.channelSettings.twitchChannel, theme);
      }
    };
    this.themeWorker.onThemeChange(this.themeChangeHandler);
  }

  private createTwitchCloseButton() {
    if (!this.chatContainer || this.twitchCloseButton) return;

    this.twitchCloseButton = document.createElement('button');
    this.twitchCloseButton.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path d="M8.5 10L4 5.5 5.5 4 10 8.5 14.5 4 16 5.5 11.5 10l4.5 4.5-1.5 1.5-4.5-4.5L5.5 16 4 14.5 8.5 10z"/>
      </svg>
    `;
    this.twitchCloseButton.title = 'Close Twitch Chat';
    this.twitchCloseButton.style.cssText = `
      position: absolute;
      top: 8px;
      left: 8px;
      z-index: 1000;
      background: transparent;
      border: none;
      border-radius: 4px;
      padding: 6px;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      opacity: 0;
      pointer-events: none;
    `;

    this.twitchCloseButton.addEventListener('mouseenter', () => {
      if (this.twitchCloseButton) {
        this.twitchCloseButton.style.background = 'transparent';
      }
    });

    this.twitchCloseButton.addEventListener('mouseleave', () => {
      if (this.twitchCloseButton) {
        this.twitchCloseButton.style.background = 'transparent';
      }
    });

    this.twitchCloseButton.addEventListener('click', () => {
      console.log('Twitch chat close button clicked');
    });

    this.chatContainer.appendChild(this.twitchCloseButton);
  }

  private showiFrame(iframe: HTMLIFrameElement) {
    iframe.style.opacity = '1';
    iframe.style.pointerEvents = 'auto';
    iframe.style.position = 'static';
    iframe.style.visibility = 'visible';

    // Show close button when Twitch iframe is shown
    if (iframe === this.twitchIframe && this.twitchCloseButton) {
      this.twitchCloseButton.style.opacity = '1';
      this.twitchCloseButton.style.pointerEvents = 'auto';
    }
  }

  private hideiFrame(iframe: HTMLIFrameElement) {
    iframe.style.opacity = '0';
    iframe.style.pointerEvents = 'none';
    iframe.style.position = 'absolute';
    iframe.style.visibility = 'hidden';

    // Hide close button when Twitch iframe is hidden
    if (iframe === this.twitchIframe && this.twitchCloseButton) {
      this.twitchCloseButton.style.opacity = '0';
      this.twitchCloseButton.style.pointerEvents = 'none';
    }
  }

  private setupEventListeners() {
    // Listen for storage changes
    this.storageChangeListener = (
      changes: { [key: string]: chrome.storage.StorageChange },
      _areaName: string
    ) => {
      const { newValue, oldValue }: { newValue?: ExtensionSettings; oldValue?: ExtensionSettings } =
        changes.yt_twitch_chat_settings;
      if (!newValue || !oldValue) return;
      if (newValue.channels[this.channelName] === oldValue.channels[this.channelName]) {
        return;
      }
      this.channelSettings = newValue.channels[this.channelName];
      this.updateChatVisibility();
    };

    // Listen for toggle events
    this.chatToggleHandler = (ev: Event) => {
      const event = ev as CustomEvent;
      const { preferredChat } = event.detail ?? {};
      if (preferredChat && this.channelSettings) {
        this.channelSettings.preferredChat = preferredChat;
        this.updateChatVisibility();
      }
    };

    chrome.storage.onChanged.addListener(this.storageChangeListener);
    window.addEventListener('chatToggleChanged', this.chatToggleHandler as EventListener);
  }

  private getChatContainer(): void {
    if (!this.youtubeiFrame) {
      this.findYouTubeChat();
    }
    if (!this.youtubeiFrame) return;
    const chatContainer = this.youtubeiFrame.parentElement as HTMLElement | null;
    if (!chatContainer) return;
    this.chatContainer = chatContainer;

    // Track original inline style to restore later
    this.chatContainerOriginalPosition = chatContainer.style.position;
    if (getComputedStyle(chatContainer).position === 'static') {
      chatContainer.style.position = 'relative';
    }
    this.chatContainer = chatContainer;
  }

  private getTwitchChatUrl(twitchChannel: string, theme: 'light' | 'dark'): string {
    return `https://www.twitch.tv/embed/${twitchChannel}/chat?parent=www.youtube.com${theme === 'dark' ? '&darkpopout' : ''}`;
  }

  private findYouTubeChat() {
    if (this.youtubeiFrame) return;
    const ytIframe = document.getElementById('chatframe') as HTMLIFrameElement;
    if (ytIframe) {
      this.youtubeiFrame = ytIframe;
      this.youtubeiFrame.style.transition = 'opacity 0.3s ease-in-out';
      this.updateChatVisibility();
    }
  }

  private removeTwitchChat() {
    if (this.twitchIframe) {
      this.twitchIframe.remove();
      this.twitchIframe = undefined;
    }
    if (this.twitchCloseButton) {
      this.twitchCloseButton.remove();
      this.twitchCloseButton = undefined;
    }
  }

  public destroy() {
    // Remove event listeners
    if (this.storageChangeListener) {
      chrome.storage.onChanged.removeListener(this.storageChangeListener);
      this.storageChangeListener = undefined;
    }
    if (this.chatToggleHandler) {
      window.removeEventListener('chatToggleChanged', this.chatToggleHandler as EventListener);
      this.chatToggleHandler = undefined;
    }

    // Unregister theme listener if available
    if (this.themeChangeHandler) {
      // New API on theme worker to support cleanup
      this.themeWorker.unregisterThemeChangeListener(this.themeChangeHandler);
      this.themeChangeHandler = undefined;
    }

    // Remove Twitch chat iframe and close button
    this.removeTwitchChat();

    // Restore YouTube chat iframe visibility/styles
    if (this.youtubeiFrame) {
      this.youtubeiFrame.style.opacity = '';
      this.youtubeiFrame.style.pointerEvents = '';
      this.youtubeiFrame.style.position = '';
      this.youtubeiFrame.style.visibility = '';
      this.youtubeiFrame.style.transition = '';
    }

    // Restore chat container styles
    if (this.chatContainer) {
      if (this.chatContainerOriginalPosition !== undefined) {
        this.chatContainer.style.position = this.chatContainerOriginalPosition;
      }
      this.chatContainer = null;
      this.chatContainerOriginalPosition = undefined;
    }

    // Destroy prompt worker
    this.promptWorker.destroy();

    // Clear references
    this.youtubeiFrame = undefined;
  }
}
